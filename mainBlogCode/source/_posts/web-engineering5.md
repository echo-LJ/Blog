---
title: å‰ç«¯å·¥ç¨‹åŒ–---çç¢å°è®°
date: 2020-12-17 10:00:00
tags: å‰ç«¯å·¥ç¨‹åŒ–
---
<meta name="referrer" content="no-referrer"/>

## Node.jsè¯ç”Ÿå¸¦æ¥çš„æŠ€æœ¯æ›´æ–°ï¼Ÿ
----
1. æ”¹è¿›ï¼š 
  é€šè¿‡Node.js,é™¤äº†å‰ç«¯å·¥å…·é“¾ã€å·¥ç¨‹åŒ–å¾—ä»¥å‘å±•ï¼Œå‰ç«¯ä¹Ÿå®ç°BFFï¼ˆBackend For Frontendï¼‰
  * è‡ªè¡Œç¼–å†™åç«¯æœåŠ¡ï¼Œå®ç°æ•°æ®çš„é€‚é…ï¼Œåº”ç”¨åœºæ™¯åŒ…æ‹¬æ¥å£çš„æ•´åˆç¼–æ’ã€å­—æ®µè£å‰ªï¼›
  * å®ç°SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ç›´å‡ºï¼‰æŠ€æœ¯ï¼Œè¾¾åˆ°æå‡é¦–å±æ€§èƒ½ä»¥åŠ SEO å‹å¥½çš„ç›®çš„ï¼›

2. æ”¹è¿›å¸¦æ¥çš„æˆæœ¬ï¼š

  è½åœ°Node.js å’Œ SSRæ¶æ„æ¨¡å¼ ä»è€Œå°±è¦å…³å¿ƒæœåŠ¡å™¨çš„è¿ç»´ã€éƒ¨ç½²ã€å‘å¸ƒã€ç›‘æ§ã€‚

3. æˆæœ¬å¸¦æ¥çš„æ–°æŠ€æœ¯å˜æ›´ï¼š

  Serverlessæ¦‚å¿µï¼šè¿è¡Œå’Œæ„å»ºä¸éœ€è¦æœåŠ¡å™¨ç®¡ç†çš„åº”ç”¨ç¨‹åºçš„æ¦‚å¿µã€‚
  * å°†æœåŠ¡å™¨çš„è¿ç»´åŠŸèƒ½éƒ½äº¤ç»™ Serverless å¹³å°è¿›è¡Œç®¡ç†ï¼Œç ”å‘äººå‘˜åªéœ€è¦ä¸“æ³¨äºå®ç°äº‘å‡½æ•°å³å¯å®ŒæˆåŠŸèƒ½å¼€å‘ã€‚

## å‰ç«¯æŠ€æœ¯æ¶æ„çš„ç‰¹ç‚¹ï¼Ÿ
----
* ç»„ä»¶åŒ–æ˜¯åŸºæœ¬ UI æ¶æ„
* ä¾æ‰˜äº SSR åŒæ„æŠ€æœ¯ä»¥åŠå¿ƒæ™ºè´Ÿæ‹…çš„æœ€å°åŒ–ï¼Œæ¡†æ¶å±‚é¢æä¾›çš„è™šæ‹Ÿ DOM ä¼šæˆä¸ºç”Ÿæ€æ ‡é…ï¼›
* æ•°æ®çŠ¶æ€ç®¡ç†æ–¹æ¡ˆå°†ä¼šä»¥èŒè´£å•ä¸€ã€minimal necessary ä¸ºç›®æ ‡ï¼Œä»¥ç»„åˆæ€§ã€å‡½æ•°å¼ä¸ºç†å¿µï¼Œè€Œä¸ä»¥åŒå‘æ•°æ®æµå’Œå•å‘æ•°æ®æµçš„åŒºåˆ†ä¸ºé‡ç‚¹ï¼›

## CSR â†’ SSR â†’ NSR â†’ ESR å‡ ç§æ¸²æŸ“æ–¹æ¡ˆçš„ç‰¹ç‚¹ï¼Ÿ
----
**CSRï¼šClient Side Rendering**ï¼š
* å®ç°äº†å‰åç«¯æ¶æ„åˆ†ç¦»ï¼ŒèŒè´£åˆ†ç¦»ã€‚
* TTFB(ç½‘ç«™åŠ è½½) æ—¶é—´æœ€å°ï¼Œä½†ç”±äºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¼šæœ‰å¤šæ¬¡äº¤äº’ï¼ˆè·å–é™æ€èµ„æºã€è·å–æ•°æ®ï¼‰æ‰èƒ½è¿›è¡Œæ¸²æŸ“ï¼Œå®é™…é¦–å±æ•ˆæœä»¥åŠ FCP/FMP æ—¶é—´ä¸å¤Ÿç†æƒ³ã€‚

**SSRï¼šServer Side Rendering**ï¼š
* åœ¨æœåŠ¡ç«¯å®Œæˆé¡µé¢æ¨¡æ¿ã€æ•°æ®é¢„å–ã€å¡«å……ï¼Œå¹¶ä¸”åœ¨æœåŠ¡ç«¯å°±å¯ä»¥å°†å®Œæ•´çš„ HTML å†…å®¹è¿”å›ç»™æµè§ˆå™¨ã€‚

ä½¿æ€§èƒ½ä¼˜åŒ–åˆ°æè‡´ è¿˜å¯ä»¥å‘å±•ï¼š `Streaming server renderingï¼ˆæµå¼ SSR æ¸²æŸ“ï¼‰`æˆ– `Progressive Rehydrationï¼ˆæ¸è¿›å¼ SSR æ¸²æŸ“ï¼‰`

* æµå¼ SSR æ¸²æŸ“ï¼Œå…è®¸æœåŠ¡ç«¯é€šè¿‡ stream çš„æ–¹å¼å‘æµè§ˆå™¨å‘é€ HTML å†…å®¹ã€‚åœ¨ React ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨renderToNodeStream()æ–¹æ³•æ¥å®Œæˆæµå¼ SSR æ¸²æŸ“ã€‚

* æ¸è¿›å¼ SSR æ¸²æŸ“å¯ä»¥å…è®¸åœ¨ hydrating æ²¡æœ‰å®Œå…¨ç»“æŸå‰ï¼Œéƒ¨åˆ†å·²ç»æ¸²æŸ“å¹¶æ³¨æ°´å®Œæˆçš„é¡µé¢å†…å®¹ï¼Œå¯ä»¥ä¼˜å…ˆå®Œæˆäº¤äº’å“åº”ã€‚React ä¸“é—¨å°†Partial Hydrationå¼€äº†ä¸€ä¸ª PR æ¥è®¨è®ºã€‚

**NSRï¼šNative Side Rendering**ï¼š
ç®€å•è¯´å°±æ˜¯é€šè¿‡ Native æ¸²æŸ“ç”Ÿæˆ HTML æ•°æ®ï¼Œå¹¶ä¸”ç¼“å­˜åœ¨å®¢æˆ·ç«¯ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¯¹äºä¸€ä¸ª hybrid WebView çš„ç”¨æˆ·è®¿é—®ï¼Œä¼šä¼˜å…ˆä»ç¦»çº¿åŒ…ä¸­åŠ è½½ç¦»çº¿é¡µé¢æ¨¡æ¿ï¼Œå†é€šè¿‡å‰ç«¯ Ajax/æˆ–å®¢æˆ·ç«¯èƒ½åŠ›è¯·æ±‚æ•°æ®ï¼Œæœ€ç»ˆå®Œæˆé¡µé¢å®Œæ•´çš„å±•ç¤ºã€‚

* å¥½å¤„ï¼šæˆ‘ä»¬å°†æœåŠ¡å™¨çš„æ¸²æŸ“å·¥ä½œæ”¾åœ¨äº†ä¸€ä¸ªä¸ªç‹¬ç«‹çš„ç§»åŠ¨è®¾å¤‡ä¸­ï¼Œå¹¶å€ŸåŠ©ç¦»çº¿å­˜å‚¨æŠ€æœ¯ï¼Œå®ç°äº†é¡µé¢çš„é¢„åŠ è½½ï¼ŒåŒæ—¶åˆä¸ä¼šå¢åŠ é¢å¤–çš„æœåŠ¡å™¨å‹åŠ›ã€‚

**ESRï¼šEdge Side Rendering**ï¼š

* è¾¹ç¼˜è®¡ç®—ï¼Œæ˜¯æŒ‡åœ¨é è¿‘ç‰©æˆ–æ•°æ®æºå¤´çš„ä¸€ä¾§ï¼Œé‡‡ç”¨ç½‘ç»œã€è®¡ç®—ã€å­˜å‚¨ã€åº”ç”¨æ ¸å¿ƒèƒ½åŠ›ä¸ºä¸€ä½“çš„å¼€æ”¾å¹³å°ï¼Œå°±è¿‘æä¾›æœ€è¿‘ç«¯æœåŠ¡ã€‚

## npmå®‰è£…æœºåˆ¶
----
#### npmåœ¨å·¥ç¨‹é¡¹ç›®ä¸­çš„ä½œç”¨ï¼Ÿ
* è´Ÿè´£ä¾èµ–çš„å®‰è£…å’Œç»´æŠ¤
* é€šè¿‡npm scripts ä¸²è”èµ·é¡¹ç›®çš„æ™ºèƒ½éƒ¨åˆ†ï¼Œè®©ç‹¬ç«‹çš„ç¯èŠ‚è‡ªåŠ¨è¿è½¬èµ·æ¥ã€‚
#### npmçš„å®‰è£…æœºåˆ¶
`æ‰©å±•:` Rubyçš„Gemã€Pythonçš„pipéƒ½æ˜¯å…¨å±€å®‰è£…
* ä¼˜å…ˆå®‰è£…ä¾èµ–åŒ…åˆ°å½“å‰é¡¹ç›®ç›®å½•ï¼Œä½¿å¾—ä¸åŒåº”ç”¨é¡¹ç›®çš„ä¾èµ–å„æˆä½“ç³»ï¼ŒåŒæ—¶è¿˜å‡è½»äº†åŒ…ä½œè€…çš„ API å…¼å®¹æ€§å‹åŠ›ã€‚
* å®‰è£…æœºåˆ¶ç¼ºç‚¹ï¼š å› ä¸ºå¤šä¸ªé¡¹ç›®éœ€è¦å®‰è£…ç›¸åŒçš„ä¾èµ–ï¼Œä¼šå¯¼è‡´åŒä¸€ä¸ªä¾èµ–åŒ…åœ¨ç”µè„‘ä¸­å¤šæ¬¡å®‰è£….

**`npm installçš„æœºåˆ¶ç¤ºæ„å›¾`**

![image.png](https://s0.lgstatic.com/i/image2/M01/02/A9/Cip5yF_axkqAclTFAAJmlxGYSmI551.png)

#### npmçš„ç¼“å­˜æœºåˆ¶
**å¯¹äºä¸€ä¸ªä¾èµ–åŒ…çš„åŒä¸€ç‰ˆæœ¬è¿›è¡Œæœ¬åœ°åŒ–ç¼“å­˜ï¼Œæ˜¯å½“ä»£ä¾èµ–åŒ…ç®¡ç†å·¥å…·çš„ä¸€ä¸ªå¸¸è§è®¾è®¡ã€‚**
æ‰§è¡Œå‘½ä»¤
```
npm config get cache
```

å¾—åˆ°é…ç½®ç¼“å­˜çš„æ ¹ç›®å½•åœ¨ `/Users/cehou/.npm`ï¼ˆ Mac OS ä¸­ï¼Œnpm é»˜è®¤çš„ç¼“å­˜ä½ç½®ï¼‰ å½“ä¸­ã€‚æˆ‘ä»¬ cd è¿›å…¥ `/Users/cehou/.npm` ä¸­å¯ä»¥å‘ç°`_cacache`æ–‡ä»¶ã€‚äº‹å®ä¸Šï¼Œåœ¨ npm v5 ç‰ˆæœ¬ä¹‹åï¼Œç¼“å­˜æ•°æ®å‡æ”¾åœ¨æ ¹ç›®å½•ä¸­çš„_cacacheæ–‡ä»¶å¤¹ä¸­ã€‚
ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¸…é™¤ /Users/cehou/.npm/_cacache ä¸­çš„æ–‡ä»¶ï¼š
```
npm cache clean --force
```
æ¥ä¸‹æ¥æ‰“å¼€`_cacache`æ–‡ä»¶ï¼Œçœ‹çœ‹ npm ç¼“å­˜äº†å“ªäº›ä¸œè¥¿ï¼Œä¸€å…±æœ‰ 3 ä¸ªç›®å½•ï¼š
* content-v2: ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†äºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰©å±•åæ”¹ä¸º.tgzï¼Œè§£å‹ä¹‹åå°±æ˜¯npmåŒ…èµ„æº

* index-v5ï¼šåŒä¸Šæ“ä½œï¼Œå¾—åˆ°çš„æ˜¯content-v2é‡Œæ–‡ä»¶çš„ç´¢å¼•

* tmp
>è¿™äº›ç¼“å­˜å¦‚ä½•è¢«å‚¨å­˜å¹¶è¢«åˆ©ç”¨çš„å‘¢ï¼Ÿ

ï¼ï¼åœ¨npm v5ç‰ˆæœ¬æ‰æ”¯æŒç¼“å­˜

npm install => é€šè¿‡`pacote`æŠŠç›¸åº”çš„åŒ…è§£å‹åœ¨å¯¹åº”çš„ node_modules ä¸‹é¢ã€‚=> npmä¸‹è½½ä¾èµ–æ—¶ï¼Œå…ˆä¸‹è½½åˆ°ç¼“å­˜å½“ä¸­ï¼Œåœ¨è§£å‹åˆ°é¡¹ç›®çš„node_modulesä¸­ã€‚=> pacoteä¾èµ–npm-registry-fetchæ¥ä¸‹è½½åŒ…ï¼Œnpm-registry-fetchå¯ä»¥é€šè¿‡è®¾ç½®cacheå±æ€§ï¼Œåœ¨ç»™å®šçš„è·¯å¾„ä¸‹æ ¹æ®
IETF RFC 7234ç”Ÿæˆç¼“å­˜æ•°æ®ã€‚

åœ¨æ¯æ¬¡å®‰è£…èµ„æºæ—¶ï¼Œæ ¹æ®package-lock.json ä¸­å­˜å‚¨çš„ integrityã€versionã€name ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ keyï¼Œè¿™ä¸ª key èƒ½å¤Ÿå¯¹åº”åˆ° index-v5 ç›®å½•ä¸‹çš„ç¼“å­˜è®°å½•ã€‚å¦‚æœå‘ç°æœ‰ç¼“å­˜èµ„æºï¼Œå°±ä¼šæ‰¾åˆ° tar åŒ…çš„ hashï¼Œæ ¹æ® hash å†å»æ‰¾ç¼“å­˜çš„ tar åŒ…ï¼Œå¹¶å†æ¬¡é€šè¿‡pacoteæŠŠå¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹åˆ°ç›¸åº”çš„é¡¹ç›® node_modules ä¸‹é¢ï¼Œçœå»äº†ç½‘ç»œä¸‹è½½èµ„æºçš„å¼€é”€ã€‚
## npmçš„å°æŠ€å·§
----

#### è‡ªå®šä¹‰npm init
`åŸç†`ï¼š è°ƒç”¨shellè„šæœ¬è¾“å‡ºä¸€ä¸ªåˆå§‹åŒ–çš„package.json
å®ç°ä¸€ä¸ªæ›´åŠ çµæ´»çš„è‡ªå®šä¹‰åŠŸèƒ½ï¼š

ä½¿ç”¨ prompt() æ–¹æ³•ï¼Œè·å–ç”¨æˆ·è¾“å…¥å¹¶åŠ¨æ€äº§ç”Ÿçš„å†…å®¹ï¼š
```
.npm-init.js
const desc = prompt('è¯·è¾“å…¥é¡¹ç›®æè¿°', 'é¡¹ç›®æè¿°...')
module.exports = {
  key: 'value',
  name: prompt('name?', process.cwd().split('/').pop()),
  version: prompt('version?', '0.0.1'),
  description: desc,
  main: 'index.js',
  repository: prompt('github repository url', '', function (url) {
    if (url) {
      run('touch README.md');
      run('git init');
      run('git add README.md');
      run('git commit -m "first commit"');
      run(`git remote add origin ${url}`);
      run('git push -u origin master');
    }
    return url;
  })
}
```
* æ‰§è¡Œå‘½ä»¤æ¥ç¡®ä¿ npm init æ‰€å¯¹åº”çš„è„šæœ¬æŒ‡å‘æ­£ç¡®çš„æ–‡ä»¶ï¼š
```
npm config set init-module ~\.npm-init.js
```
è¿˜å¯ä»¥é€šè¿‡é…ç½®npm init é»˜è®¤å­—æ®µæ¥è‡ªå®šä¹‰npm initå†…å®¹
#### åˆ©ç”¨ `npm link`ï¼Œé«˜æ•ˆç‡åœ¨æœ¬åœ°è°ƒè¯•ä»¥éªŒè¯åŒ…çš„å¯ç”¨æ€§

> å½“æˆ‘ä»¬å¼€å‘å®Œæˆä¸€ä¸ªç»„ä»¶åº“ï¼Œå¦‚ä½•éªŒè¯è¯¥ç»„ä»¶åœ¨æˆ‘çš„ä¸šåŠ¡é¡¹ç›®ä¸­æ­£å¸¸è¿è¡Œå‘¢ï¼Ÿ

**ä¸¾ä¸ªğŸŒ°**ï¼šæ­£åœ¨å¼€å‘é¡¹ç›® project 1ï¼Œå…¶ä¸­æœ‰ä¸ªåŒ… package 1ï¼Œå¯¹åº” npm æ¨¡å—åŒ…åç§°æ˜¯ npm-package-1ï¼Œæˆ‘ä»¬åœ¨ package 1 é¡¹ç›®ä¸­åŠ å…¥äº†æ–°åŠŸèƒ½ feature Aï¼Œç°åœ¨è¦éªŒè¯åœ¨ project 1 é¡¹ç›®ä¸­èƒ½å¦æ­£å¸¸ä½¿ç”¨ package 1 çš„ feature Aï¼Œä½ åº”è¯¥æ€ä¹ˆåšï¼Ÿ

* åœ¨ package 1 ç›®å½•ä¸­ï¼Œæ‰§è¡Œ `npm link`ï¼Œè¿™æ · npm link é€šè¿‡é“¾æ¥ç›®å½•å’Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ç° npm åŒ…å‘½ä»¤çš„å…¨å±€å¯æ‰§è¡Œã€‚

* åœ¨ project 1 ä¸­åˆ›å»ºé“¾æ¥ï¼Œæ‰§è¡Œ npm link npm-package-1 å‘½ä»¤æ—¶ï¼Œå®ƒå°±ä¼šå» /usr/local/lib/node_modules/ è¿™ä¸ªè·¯å¾„ä¸‹å¯»æ‰¾æ˜¯å¦æœ‰è¿™ä¸ªåŒ…ï¼Œå¦‚æœæœ‰å°±å»ºç«‹è½¯é“¾æ¥ã€‚

* å°±å¯ä»¥åœ¨ project 1 çš„ node_module ä¸­ä¼šçœ‹åˆ°é“¾æ¥è¿‡æ¥çš„æ¨¡å—åŒ… npm-package-1ï¼Œæ­¤æ—¶çš„ npm-package-1 å°±å¸¦æœ‰æœ€æ–°å¼€å‘çš„ feature Aï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥åœ¨ project 1 ä¸­æ­£å¸¸å¼€å‘è°ƒè¯• npm-package-1ã€‚

* !å½“ç„¶åˆ«å¿˜äº†ï¼Œè°ƒè¯•ç»“æŸåå¯ä»¥æ‰§è¡Œ npm unlink ä»¥å–æ¶ˆå…³è”ã€‚

**`npm linkåŸç†`**ï¼š 

1. ä¸ºç›®æ ‡ npm æ¨¡å—ï¼ˆnpm-package-1ï¼‰åˆ›å»ºè½¯é“¾æ¥ï¼Œå°†å…¶é“¾æ¥åˆ°å…¨å±€ node æ¨¡å—å®‰è£…è·¯å¾„ /usr/local/lib/node_modules/ ä¸­ï¼›

2. ä¸ºç›®æ ‡ npm æ¨¡å—ï¼ˆnpm-package-1ï¼‰çš„å¯æ‰§è¡Œ bin æ–‡ä»¶åˆ›å»ºè½¯é“¾æ¥ï¼Œå°†å…¶é“¾æ¥åˆ°å…¨å±€ node å‘½ä»¤å®‰è£…è·¯å¾„ /usr/local/bin/ ä¸­ã€‚

#### npxçš„ä½œç”¨

npx ç”± npm v5.2 ç‰ˆæœ¬å¼•å…¥ï¼Œè§£å†³äº† npm çš„ä¸€äº›ä½¿ç”¨å¿«é€Ÿå¼€å‘ã€è°ƒè¯•ï¼Œä»¥åŠé¡¹ç›®å†…ä½¿ç”¨å…¨å±€æ¨¡å—çš„ç—›ç‚¹ã€‚

* é¡¹ç›®å®‰è£…ä½¿ç”¨eslint
**`ä¸¾ä¸ªnpmğŸŒ°`**: 
åœ¨ä¼ ç»Ÿçš„npm æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨eslint,éœ€è¦å…ˆæ‰§è¡Œå‘½ä»¤å®‰è£…
```
npm install eslint --save-dev
```
ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š

```
./node_modules/.bin/eslint --init
./node_modules/.bin/eslint yourfile.js
```
æˆ–è€…é€šè¿‡é¡¹ç›®è„šæœ¬å’Œ package.json çš„ npm scripts å­—æ®µè°ƒç”¨ ESLintã€‚
**`ä¸¾ä¸ªnpxğŸŒ°`**: 
æ‰§è¡Œå‘½ä»¤å³å¯
```
npx eslint --init
npx eslint yourfile.js
```
> ä¸ºä»€ä¹ˆ npx æ“ä½œèµ·æ¥å¦‚æ­¤ä¾¿æ·å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºå®ƒå¯ä»¥ç›´æ¥æ‰§è¡Œ node_modules/.bin æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ã€‚åœ¨è¿è¡Œå‘½ä»¤æ—¶ï¼Œnpx å¯ä»¥è‡ªåŠ¨å» node_modules/.bin è·¯å¾„å’Œç¯å¢ƒå˜é‡ $PATH é‡Œé¢æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸éœ€è¦å†åœ¨ package.json ä¸­å®šä¹‰ç›¸å…³çš„ scriptã€‚

**npx å¦ä¸€ä¸ªæ›´å®ç”¨çš„å¥½å¤„æ˜¯ï¼šnpx æ‰§è¡Œæ¨¡å—æ—¶ä¼šä¼˜å…ˆå®‰è£…ä¾èµ–ï¼Œä½†æ˜¯åœ¨å®‰è£…æ‰§è¡Œåä¾¿åˆ é™¤æ­¤ä¾èµ–ï¼Œè¿™å°±é¿å…äº†å…¨å±€å®‰è£…æ¨¡å—å¸¦æ¥çš„é—®é¢˜ã€‚**

## npm å¤šæºé•œåƒ
----
npm ä¸­çš„æºï¼ˆregistryï¼‰ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæŸ¥è¯¢æœåŠ¡ã€‚
* ä¸¾ä¸ªğŸŒ°ï¼š https://registry.npmjs.org/reactï¼Œå°±ä¼šçœ‹åˆ° react æ¨¡å—æ‰€æœ‰ç‰ˆæœ¬çš„ä¿¡æ¯ã€‚
* è®¾ç½®å®‰è£…æºï¼š 
```
npm config set
```
* ä½¿ç”¨å¤šä¸ªå®‰è£…æºçš„é¡¹ç›®ï¼Œå¯ä»¥é€šè¿‡ npm-preinstall çš„é’©å­ï¼Œé€šè¿‡ npm è„šæœ¬ï¼Œåœ¨å®‰è£…å…¬å…±ä¾èµ–å‰è‡ªåŠ¨è¿›è¡Œæºåˆ‡æ¢ï¼š
```
"scripts": {
    "preinstall": "node ./bin/preinstall.js"
}
```

```
//preinstall.js : é€šè¿‡node.jsæ‰§è¡Œnpm config setå‘½ä»¤ã€‚
require(' child_process').exec('npm config get registry', function(error, stdout, stderr) {
  if (!stdout.toString().match(/registry\.x\.com/)) {
    exec('npm config set @xscope:registry https://xxx.com/npm/')
  }
})
#### ç§æœæ‰©å±•
* éƒ¨ç½²ç§æœ‰ npm é•œåƒï¼Œå¯ä»¥æé«˜npmä¸‹è½½ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…çš„é€Ÿåº¦ç¼“æ…¢çš„é—®é¢˜
* ç¡®ä¿é«˜é€Ÿã€ç¨³å®šçš„ npm æœåŠ¡ï¼Œä½¿å‘å¸ƒç§æœ‰æ¨¡å—æ›´åŠ å®‰å…¨ã€‚
* å®¡æ ¸æœºåˆ¶ä¹Ÿå¯ä»¥ä¿éšœç§æœä¸Šçš„ npm æ¨¡å—è´¨é‡å’Œå®‰å…¨
** æ¨èæ­å»ºnpmç§æœçš„å·¥å…·**
* nexus
* verdaccio
* cnpm
```

## Yarn çš„å®‰è£…ç†å¿µ
----
å®ƒçš„å‡ºç°(npm v3æ—¶æœŸï¼Œè¿˜æ²¡æœ‰package-lock.json)æ˜¯ä¸ºäº†è§£å†³å†å²ä¸Š npm çš„æŸäº›ä¸è¶³ï¼ˆæ¯”å¦‚ npm å¯¹äºä¾èµ–çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ä¿éšœï¼Œä»¥åŠ npm å®‰è£…é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ç­‰ï¼‰
* ç¡®å®šæ€§ï¼šé€šè¿‡ yarn.lock ç­‰æœºåˆ¶ï¼Œä¿è¯äº†ç¡®å®šæ€§ã€‚å³ä¸ç®¡å®‰è£…é¡ºåºå¦‚ä½•ï¼Œç›¸åŒçš„ä¾èµ–å…³ç³»åœ¨ä»»ä½•æœºå™¨å’Œç¯å¢ƒä¸‹ï¼Œéƒ½å¯ä»¥ä»¥ç›¸åŒçš„æ–¹å¼è¢«å®‰è£…ã€‚
* é‡‡ç”¨æ¨¡å—æ‰å¹³å®‰è£…æ¨¡å¼ï¼šå°†ä¾èµ–åŒ…çš„ä¸åŒç‰ˆæœ¬ï¼ŒæŒ‰ç…§ä¸€å®šç­–ç•¥ï¼Œå½’ç»“ä¸ºå•ä¸ªç‰ˆæœ¬ï¼Œä»¥é¿å…åˆ›å»ºå¤šä¸ªå‰¯æœ¬é€ æˆå†—ä½™ï¼ˆnpm ç›®å‰ä¹Ÿæœ‰ç›¸åŒçš„ä¼˜åŒ–ï¼‰ã€‚
* é‡‡ç”¨ç¼“å­˜æœºåˆ¶ï¼Œå®ç°äº†ç¦»çº¿æ¨¡å¼

> ç›¸æ¯” npmï¼ŒYarn å¦å¤–ä¸€ä¸ªæ˜¾è‘—åŒºåˆ«æ˜¯ yarn.lock ä¸­å­ä¾èµ–çš„ç‰ˆæœ¬å·ä¸æ˜¯å›ºå®šç‰ˆæœ¬ã€‚è¿™å°±è¯´æ˜å•ç‹¬ä¸€ä¸ª yarn.lock ç¡®å®šä¸äº† node_modules ç›®å½•ç»“æ„ï¼Œè¿˜éœ€è¦å’Œ package.json æ–‡ä»¶è¿›è¡Œé…åˆã€‚

ç”šè‡³è¿˜æœ‰ä¸€ä¸ªä¸“é—¨çš„ synp å·¥å…·ï¼Œå®ƒå¯ä»¥å°† yarn.lock è½¬æ¢ä¸º package-lock.json

#### Yarn ç¼“å­˜

æŸ¥çœ‹ç¼“å­˜å†…å®¹
```
yarn cache dir
```

Yarn é»˜è®¤ä½¿ç”¨ `prefer-online` æ¨¡å¼ï¼Œå³ä¼˜å…ˆä½¿ç”¨ç½‘ç»œæ•°æ®ã€‚å¦‚æœç½‘ç»œæ•°æ®è¯·æ±‚å¤±è´¥ï¼Œå†å»è¯·æ±‚ç¼“å­˜æ•°æ®

#### Yarn å®‰è£…æœºåˆ¶
* æ£€æµ‹ï¼ˆcheckingï¼‰: 
  æ£€æµ‹é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨ä¸€äº› npm ç›¸å…³æ–‡ä»¶ï¼Œæ¯”å¦‚ package-lock.json ç­‰ã€‚å¦‚æœæœ‰ï¼Œä¼šæç¤ºç”¨æˆ·æ³¨æ„ï¼šè¿™äº›æ–‡ä»¶çš„å­˜åœ¨å¯èƒ½ä¼šå¯¼è‡´å†²çªã€‚åœ¨è¿™ä¸€æ­¥éª¤ä¸­ï¼Œä¹Ÿä¼šæ£€æŸ¥ç³»ç»Ÿ OSã€CPU ç­‰ä¿¡æ¯ã€‚
* è§£æåŒ…ï¼ˆResolving Packagesï¼‰
  è§£æpackage.json å®šä¹‰çš„ dependenciesã€devDependenciesã€optionalDependencies çš„å†…å®¹ï¼Œè¿™å±äºé¦–å±‚ä¾èµ–ã€‚
  æ¥ç€é‡‡ç”¨éå†é¦–å±‚ä¾èµ–çš„æ–¹å¼è·å–ä¾èµ–åŒ…çš„ç‰ˆæœ¬ä¿¡æ¯ 
* è·å–åŒ…ï¼ˆFetching Packagesï¼‰
  æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å½“å‰çš„ä¾èµ–åŒ…ï¼ŒåŒæ—¶å°†ç¼“å­˜ä¸­ä¸å­˜åœ¨çš„ä¾èµ–åŒ…ä¸‹è½½åˆ°ç¼“å­˜ç›®å½•ã€‚
* *é“¾æ¥åŒ…ï¼ˆLinking Packagesï¼‰
* æ„å»ºåŒ…ï¼ˆBuilding Packages


## ç ´è§£ä¾èµ–ç®¡ç†å›°å¢ƒ
----
> å¦‚ä½•ç†è§£â€œåµŒå¥—åœ°ç‹±â€å‘¢ï¼Ÿ
é¡¹ç›®ä¾èµ–æ ‘çš„å±‚çº§éå¸¸æ·±ï¼Œä¸åˆ©äºè°ƒè¯•å’Œæ’æŸ¥é—®é¢˜ï¼›
ä¾èµ–æ ‘çš„ä¸åŒåˆ†æ”¯é‡Œï¼Œå¯èƒ½å­˜åœ¨åŒæ ·ç‰ˆæœ¬çš„ç›¸åŒä¾èµ–ã€‚æ¯”å¦‚ç›´æ¥ä¾èµ– A å’Œ Bï¼Œä½† A å’Œ B éƒ½ä¾èµ–ç›¸åŒç‰ˆæœ¬çš„æ¨¡å— Cï¼Œé‚£ä¹ˆ C ä¼šé‡å¤å‡ºç°åœ¨ A å’Œ B ä¾èµ–çš„ node_modules ä¸­ã€‚

* npm åŒ…çš„å®‰è£…é¡ºåºå¯¹äºä¾èµ–æ ‘çš„å½±å“å¾ˆå¤§ã€‚æ¨¡å—å®‰è£…é¡ºåºå¯èƒ½å½±å“ node_modules å†…çš„æ–‡ä»¶æ•°é‡ã€‚

è§£å†³æ–¹æ¡ˆï¼šä¼˜é›…çš„æ–¹å¼æ˜¯ä½¿ç”¨ `npm dedupe` å‘½ä»¤

## CI ç¯å¢ƒä¸Šçš„ npm ä¼˜åŒ–
----
#### åˆç†ä½¿ç”¨ npm ci å’Œ npm install
npm ci å°±æ˜¯ä¸“é—¨ä¸º CI ç¯å¢ƒå‡†å¤‡çš„å®‰è£…å‘½ä»¤ï¼Œç›¸æ¯” npm install å®ƒçš„ä¸åŒä¹‹å¤„åœ¨äºï¼š
* npm ci è¦æ±‚é¡¹ç›®ä¸­å¿…é¡»å­˜åœ¨ package-lock.json æˆ– npm-shrinkwrap.jsonï¼›
* npm ci å®Œå…¨æ ¹æ® package-lock.json å®‰è£…ä¾èµ–ï¼Œè¿™å¯ä»¥ä¿è¯æ•´ä¸ªå¼€å‘å›¢é˜Ÿéƒ½ä½¿ç”¨ç‰ˆæœ¬å®Œå…¨ä¸€è‡´çš„ä¾èµ–ï¼› 
* æ­£å› ä¸º npm ci å®Œå…¨æ ¹æ® package-lock.json å®‰è£…ä¾èµ–ï¼Œåœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œå®ƒä¸éœ€è¦è®¡ç®—æ±‚è§£ä¾èµ–æ»¡è¶³é—®é¢˜ã€æ„é€ ä¾èµ–æ ‘ï¼Œå› æ­¤å®‰è£…è¿‡ç¨‹ä¼šæ›´åŠ è¿…é€Ÿï¼›
**package-lock.json ä¸­å·²ç»ç¼“å­˜äº†æ¯ä¸ªåŒ…çš„å…·ä½“ç‰ˆæœ¬å’Œä¸‹è½½é“¾æ¥ï¼Œä½ ä¸éœ€è¦å†å»è¿œç¨‹ä»“åº“è¿›è¡ŒæŸ¥è¯¢ï¼Œå³å¯ç›´æ¥è¿›å…¥æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒç¯èŠ‚ï¼Œå‡å°‘äº†å¤§é‡ç½‘ç»œè¯·æ±‚ã€‚**
* npm ci åœ¨æ‰§è¡Œå®‰è£…æ—¶ï¼Œä¼šå…ˆåˆ é™¤é¡¹ç›®ä¸­ç°æœ‰çš„ node_modulesï¼Œç„¶åå…¨æ–°å®‰è£…ï¼›
* npm ci åªèƒ½ä¸€æ¬¡å®‰è£…æ•´ä¸ªé¡¹ç›®æ‰€æœ‰ä¾èµ–åŒ…ï¼Œæ— æ³•å®‰è£…å•ä¸ªä¾èµ–åŒ…ï¼›
* å¦‚æœ package-lock.json å’Œ package.json å†²çªï¼Œé‚£ä¹ˆ npm ci ä¼šç›´æ¥æŠ¥é”™ï¼Œå¹¶éæ›´æ–° lockfilesï¼›
* npm ci æ°¸è¿œä¸ä¼šæ”¹å˜ package.json å’Œ package-lock.jsonã€‚

**æˆ‘ä»¬åœ¨ CI ç¯å¢ƒä½¿ç”¨ npm ci ä»£æ›¿ npm installï¼Œä¸€èˆ¬ä¼šè·å¾—æ›´åŠ ç¨³å®šã€ä¸€è‡´å’Œè¿…é€Ÿçš„å®‰è£…ä½“éªŒã€‚**

#### ä¸ºä»€ä¹ˆè¦ lockfilesï¼Œè¦ä¸è¦æäº¤ lockfiles åˆ°ä»“åº“ï¼Ÿ

**package-lock.json æ–‡ä»¶çš„ä½œç”¨æ˜¯é”å®šä¾èµ–å®‰è£…ç»“æ„ï¼Œç›®çš„æ˜¯ä¿è¯åœ¨ä»»æ„æœºå™¨ä¸Šæ‰§è¡Œ npm install éƒ½ä¼šå¾—åˆ°å®Œå…¨ç›¸åŒçš„ node_modules å®‰è£…ç»“æœã€‚**

>ä¸ºä»€ä¹ˆå•ä¸€çš„ package.json ä¸èƒ½ç¡®å®šå”¯ä¸€çš„ä¾èµ–æ ‘ï¼š

* ä¸åŒç‰ˆæœ¬çš„ npm çš„å®‰è£…ä¾èµ–ç­–ç•¥å’Œç®—æ³•ä¸åŒï¼›

* npm install å°†æ ¹æ® package.json ä¸­çš„ semver-range version æ›´æ–°ä¾èµ–ï¼ŒæŸäº›ä¾èµ–é¡¹è‡ªä¸Šæ¬¡å®‰è£…ä»¥æ¥ï¼Œå¯èƒ½å·²å‘å¸ƒäº†æ–°ç‰ˆæœ¬ã€‚

package-lock.jsonä¸­å¹¶ä¸æ˜¯æ‰€æœ‰çš„å­ä¾èµ–éƒ½æœ‰ `dependencies` å±æ€§ï¼Œåªæœ‰å­ä¾èµ–çš„ä¾èµ–å’Œå½“å‰å·²å®‰è£…åœ¨æ ¹ç›®å½•çš„ node_modules ä¸­çš„ä¾èµ–å†²çªä¹‹åï¼Œæ‰ä¼šæœ‰è¿™ä¸ªå±æ€§
#### è¦ä¸è¦æäº¤ lockfiles åˆ°ä»“åº“ï¼Ÿ
* å¦‚æœå¼€å‘ä¸€ä¸ªåº”ç”¨ï¼Œæˆ‘å»ºè®®æŠŠ package-lock.json æ–‡ä»¶æäº¤åˆ°ä»£ç ç‰ˆæœ¬ä»“åº“ã€‚è¿™æ ·å¯ä»¥ä¿è¯é¡¹ç›®ç»„æˆå‘˜ã€è¿ç»´éƒ¨ç½²æˆå‘˜æˆ–è€… CI ç³»ç»Ÿï¼Œåœ¨æ‰§è¡Œ npm install åï¼Œèƒ½å¾—åˆ°å®Œå…¨ä¸€è‡´çš„ä¾èµ–å®‰è£…å†…å®¹ã€‚
* å¦‚æœä½ çš„ç›®æ ‡æ˜¯å¼€å‘ä¸€ä¸ªç»™å¤–éƒ¨ä½¿ç”¨çš„åº“ï¼Œé‚£å°±è¦è°¨æ…è€ƒè™‘äº†ï¼Œå› ä¸ºåº“é¡¹ç›®ä¸€èˆ¬æ˜¯è¢«å…¶ä»–é¡¹ç›®ä¾èµ–çš„ï¼Œåœ¨ä¸ä½¿ç”¨ package-lock.json çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥å¤ç”¨ä¸»é¡¹ç›®å·²ç»åŠ è½½è¿‡çš„åŒ…ï¼Œå‡å°‘ä¾èµ–é‡å¤å’Œä½“ç§¯ã€‚
**`ä¸€ä¸ªæ¨èçš„åšæ³•æ˜¯ï¼š`**æŠŠ package-lock.json ä¸€èµ·æäº¤åˆ°ä»£ç åº“ä¸­ï¼Œä¸éœ€è¦ ignoreã€‚ä½†æ˜¯æ‰§è¡Œ npm publish å‘½ä»¤ï¼Œå‘å¸ƒä¸€ä¸ªåº“çš„æ—¶å€™ï¼Œå®ƒåº”è¯¥è¢«å¿½ç•¥è€Œä¸æ˜¯ç›´æ¥å‘å¸ƒå‡ºå»ã€‚

#### ä¸ºä»€ä¹ˆæœ‰ xxxDependenciesï¼Ÿ
npm è®¾è®¡äº†ä»¥ä¸‹å‡ ç§ä¾èµ–ç±»å‹å£°æ˜ï¼š

* dependencies é¡¹ç›®ä¾èµ–

* devDependencies å¼€å‘ä¾èµ–: ä¸ä¼šè¢«è‡ªåŠ¨ä¸‹è½½,æ¯”å¦‚ Webpackï¼Œé¢„å¤„ç†å™¨ babel-loaderã€scss-loaderï¼Œæµ‹è¯•å·¥å…· E2Eã€Chai ç­‰ï¼Œè¿™äº›éƒ½æ˜¯è¾…åŠ©å¼€å‘çš„å·¥å…·åŒ…ï¼Œæ— é¡»åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

* peerDependencies åŒç‰ˆæœ¬ä¾èµ–:å¦‚æœä½ å®‰è£…æˆ‘ï¼Œé‚£ä¹ˆä½ æœ€å¥½ä¹Ÿå®‰è£…æˆ‘å¯¹åº”çš„ä¾èµ–ã€‚
>peerDependencies ä¸»è¦çš„ä½¿ç”¨åœºæ™¯:
æ’ä»¶ä¸èƒ½å•ç‹¬è¿è¡Œ
æ’ä»¶æ­£ç¡®è¿è¡Œçš„å‰ææ˜¯æ ¸å¿ƒä¾èµ–åº“å¿…é¡»å…ˆä¸‹è½½å®‰è£…
æˆ‘ä»¬ä¸å¸Œæœ›æ ¸å¿ƒä¾èµ–åº“è¢«é‡å¤ä¸‹è½½
æ’ä»¶ API çš„è®¾è®¡å¿…é¡»è¦ç¬¦åˆæ ¸å¿ƒä¾èµ–åº“çš„æ’ä»¶ç¼–å†™è§„èŒƒ
åœ¨é¡¹ç›®ä¸­ï¼ŒåŒä¸€æ’ä»¶ä½“ç³»ä¸‹ï¼Œæ ¸å¿ƒä¾èµ–åº“ç‰ˆæœ¬æœ€å¥½ç›¸åŒ

* bundledDependencies æ†ç»‘ä¾èµ–: bundledDependencies å’Œ npm pack æ‰“åŒ…å‘½ä»¤æœ‰å…³.
åœ¨ bundledDependencies ä¸­æŒ‡å®šçš„ä¾èµ–åŒ…ï¼Œå¿…é¡»å…ˆåœ¨ dependencies å’Œ devDependencies å£°æ˜è¿‡ï¼Œå¦åˆ™åœ¨ npm pack é˜¶æ®µä¼šè¿›è¡ŒæŠ¥é”™ã€‚

* optionalDependencies å¯é€‰ä¾èµ–: ä¸å»ºè®®å¤§å®¶ä½¿ç”¨ï¼Œå› ä¸ºå®ƒå¤§æ¦‚ç‡ä¼šå¢åŠ é¡¹ç›®çš„ä¸ç¡®å®šæ€§å’Œå¤æ‚æ€§.
#### å›¢é˜Ÿæœ€ä½³å®æ“å»ºè®®
* ä¼˜å…ˆä½¿ç”¨ npm v5.4.2 ä»¥ä¸Šçš„ npm ç‰ˆæœ¬ï¼Œä»¥ä¿è¯ npm çš„æœ€åŸºæœ¬å…ˆè¿›æ€§å’Œç¨³å®šæ€§ã€‚

* é¡¹ç›®çš„ç¬¬ä¸€æ¬¡æ­å»ºä½¿ç”¨ npm install å®‰è£…ä¾èµ–åŒ…ï¼Œå¹¶æäº¤ package.jsonã€package-lock.jsonï¼Œè€Œä¸æäº¤ node_modules ç›®å½•ã€‚

* å…¶ä»–é¡¹ç›®æˆå‘˜é¦–æ¬¡ checkout/clone é¡¹ç›®ä»£ç åï¼Œæ‰§è¡Œä¸€æ¬¡ npm install å®‰è£…ä¾èµ–åŒ…ã€‚

å¯¹äºå‡çº§ä¾èµ–åŒ…çš„éœ€æ±‚ï¼š

ä¾é  npm update å‘½ä»¤å‡çº§åˆ°æ–°çš„å°ç‰ˆæœ¬ï¼›

ä¾é  npm install @ å‡çº§å¤§ç‰ˆæœ¬ï¼›

ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ package.json ä¸­ç‰ˆæœ¬å·ï¼Œå¹¶æ‰§è¡Œ npm install æ¥å‡çº§ç‰ˆæœ¬ï¼›

* æœ¬åœ°éªŒè¯å‡çº§åæ–°ç‰ˆæœ¬æ— é—®é¢˜ï¼Œæäº¤æ–°çš„ package.jsonã€package-lock.json æ–‡ä»¶ã€‚

* å¯¹äºé™çº§ä¾èµ–åŒ…çš„éœ€æ±‚ï¼šæ‰§è¡Œ npm install @ å‘½ä»¤ï¼ŒéªŒè¯æ²¡é—®é¢˜åï¼Œæäº¤æ–°çš„ package.jsonã€package-lock.json æ–‡ä»¶ã€‚

åˆ é™¤æŸäº›ä¾èµ–ï¼š

* æ‰§è¡Œ npm uninstall å‘½ä»¤ï¼ŒéªŒè¯æ²¡é—®é¢˜åï¼Œæäº¤æ–°çš„ package.jsonã€package-lock.json æ–‡ä»¶ï¼›

* æˆ–è€…æ‰‹åŠ¨æ“ä½œ package.jsonï¼Œåˆ é™¤ä¾èµ–ï¼Œæ‰§è¡Œ npm install å‘½ä»¤ï¼ŒéªŒè¯æ²¡é—®é¢˜åï¼Œæäº¤æ–°çš„ package.jsonã€package-lock.json æ–‡ä»¶ã€‚

* ä»»ä½•å›¢é˜Ÿæˆå‘˜æäº¤ package.jsonã€package-lock.json æ›´æ–°åï¼Œå…¶ä»–æˆå‘˜åº”è¯¥æ‹‰å–ä»£ç åï¼Œæ‰§è¡Œ npm install æ›´æ–°ä¾èµ–ã€‚

* ä»»ä½•æ—¶å€™éƒ½ä¸è¦ä¿®æ”¹ package-lock.jsonã€‚

* å¦‚æœ package-lock.json å‡ºç°å†²çªæˆ–é—®é¢˜ï¼Œå»ºè®®å°†æœ¬åœ°çš„ package-lock.json æ–‡ä»¶åˆ é™¤ï¼Œå¼•å…¥è¿œç¨‹çš„ package-lock.json æ–‡ä»¶å’Œ package.jsonï¼Œå†æ‰§è¡Œ npm install å‘½ä»¤ã€‚






----
æ€»ç»“ï¼šå¤§åŠŸå‘ŠæˆâœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸

å‚è€ƒé“¾æ¥ï¼šhttps://kaiwu.lagou.com/course/courseInfo.htm?courseId=584#/detail/pc?id=5907





