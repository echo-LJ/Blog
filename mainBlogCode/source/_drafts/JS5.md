---
title: 单线程的 JavaScript 如何管理任务？
date: 2021-04-14 16:50:59
tags: Js
---

<meta name="referrer" content="no-referrer"/>

## JavaScript 代码运行的各个阶段?

---

在 V8 引擎中 JavaScript 代码的运行过程主要分成三个阶段。
**`语法分析阶段`:**该阶段会对代码进行语法分析，检查是否会有语法错误(SyntaxError),如果发现错误，会在控制台抛出异常，并终止执行。
**`编译阶段`:**该阶段会进行执行上下文(Execution Context)的创建, 包括创建变量对象，建立作用域链、确定this指向等，每进入一个不同的环境时，V8引擎都会创建一个新的执行上下文。
**`执行阶段`:**将编译阶段创建的执行上下文压入调用栈，并成为正在运行的执行上下文，代码执行结束后,将其弹出调用栈，调用栈遵循 LIFO（先进后出，后进先出）原则。

## 执行上下文的创建?

---
执行上下文的创建离不开JavaScript运行环境，JavaScript运行环境包括全局环境，函数环境和eval, 其中全局环境和函数环境的创建过程如下：

* 1）第一次载入JavaScript代码时，首先会创建一个全局环境，全局环境在最外层，直到应用程序退出后（例如关闭浏览器或网页），才会被销毁。
* 2）每个函数都有自己的运行环境，只有函数被调用，才会进入函数的运行环境，只有当函数中的代码全部执行完，运行环境才会被销毁。不同的函数运行环境不一样，即使是同一个函数，多次调用时也会创建多个不同的函数环境。

在不同的运行环境中，变量和函数可访问的其他数据范围不同，环境的不同（比如创建和销毁）也有所区别。而每进入一个不同的运行环境时，Javascript都会创建一个新的执行上下文，该过程包括：

* 建立作用域链
* 创建变量对象
* 确定this指向

## 创建变量对象?

---
**`什么是变量对象呢？`:**每个执行上下文都会又一个关联的变量对象，该对象上会保存这个上下文中定义的所有变量和函数。

* 在浏览器中，全局环境的变量对象是`window对象`，因此所有的全局变量和函数都是作为window对象的属性和方法创建的。
* 在 Node 中全局环境的变量对象则是`global`对象

**`创建变量对象的过程`:**
创建变量对象将创建arguments（仅函数环境）对象，同时会检测上下文中的函数声明、变量声明。

* 变量声明： 会给变量分配内存，并初始化为undefined(此阶段只定义变量，执行阶段会进行赋值)。
* 函数声明： 会在内存里创建函数对象，并直接初始化为函数对象。

`上述的函数声明、变量声明就是我们常说的变量提升和函数提升,其中函数声明会优先于变量声明的提升`
因为变量提升容易带来变量在预期外被覆盖掉的问题，同时还可能导致本应该被销毁的变量没有被销毁等情况。
因此 ES6 中引入了let和const关键字，从而使 JavaScript 也拥有了块级作用域。

在编程语言中，分静态作用域、动态作用域，而Javascript属于词法作用域，即静态作用域。词法作用域中的变量，会在编译过程中产生一个确定的作用域。这个作用域即当前执行的上下文，在ES5后通过`词法环境`来替换作用域来描述执行上下文。

在JavaScript中词法环境又分为`词法环境`和`变量环境`两种，其中：

* 变量环境用来记录var/function等变量声明；
* 词法环境是用来记录let/const/class等变量声明。

也就是说创建变量对象过程会进行变量提升和函数提升。

## 建立作用域链?

**`作用域链？`:**顾名思义，就是将各个作用域通过某种方式连接在一起。

作用域就是词法环境，而词法环境是通过两个成员组成：

* 环境记录： 用于记录自身词法环境中的变量对象。
* 外部词法环境引用： 记录外层词法环境的引用。

通过外层词法环境的饮用，作用域可以层层拓展，形成由内向外延伸的作用域链。当某个变量无法在自身词法环境记录中找到时，可以根据外部此法环境饮用，去外层作用域查找，直到最外层作用域外部词法引用仍为null，这便是作用域链的变量查询.
---

---
总结：大功告成✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️✌️
